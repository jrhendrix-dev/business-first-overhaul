<app-toast-container />
<app-admin-header title="Users"></app-admin-header>

<div class="h-full flex flex-col min-h-0">
  <!-- Unified container -->
  <div class="min-h-0 grow border rounded overflow-hidden">
    <!-- Filters INSIDE the box -->
    <div class="px-3 py-3 border-b flex items-end gap-3">
      <div>
        <label class="block text-xs text-slate-600">Search</label>
        <input class="border rounded px-2 py-1 w-64"
               [formControl]="filters.controls.q"
               placeholder="username, email, or name">
      </div>

      <div>
        <label class="block text-xs text-slate-600">Role</label>
        <select class="border rounded px-2 py-1 w-44" [formControl]="filters.controls.role">
          <option value="">Any</option>
          <option value="ROLE_ADMIN">Admin</option>
          <option value="ROLE_TEACHER">Teacher</option>
          <option value="ROLE_STUDENT">Student</option>
        </select>
      </div>

      <!-- Reserve the Actions width on the right -->
      <div class="ml-auto w-[calc(7rem+1.5rem)] flex justify-end">
        <button class="btn btn-success" (click)="openCreate()">+ Add user</button>
      </div>
    </div>

    <!-- Scrollable table -->
    <div class="overflow-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 border-b sticky top-0 z-10">
        <tr>
          <th class="text-left px-3 py-2 w-16">ID</th>
          <th class="text-left px-3 py-2">Name</th>
          <th class="text-left px-3 py-2">Username</th>
          <th class="text-left px-3 py-2">Email</th>
          <th class="text-left px-3 py-2 w-28">Role</th>
          <th class="text-left px-3 py-2 w-48">Classes</th>
          <th class="text-left px-3 py-2 w-24">Active</th>
          <th class="text-left px-3 py-2 w-40">Created</th>
          <th class="text-left px-3 py-2 w-28">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let u of viewItems()" class="border-b hover:bg-slate-50">
          <td class="px-3 py-2">{{ u.id }}</td>
          <td class="px-3 py-2">{{ nameOf(u) }}</td>
          <td class="px-3 py-2">{{ u.userName }}</td>
          <td class="px-3 py-2">{{ u.email }}</td>
          <td class="px-3 py-2">{{ u.role || '—' }}</td>
          <td class="px-3 py-2">
            <app-class-list-cell [classes]="classesOf(u)" [manageQuery]="manageQuery(u)"></app-class-list-cell>
          </td>
          <td class="px-3 py-2">
            <span class="inline-flex items-center gap-1">
              <span class="h-2.5 w-2.5 rounded-full"
                    [class.bg-emerald-500]="u.isActive"
                    [class.bg-slate-300]="!u.isActive"></span>
              {{ u.isActive ? 'Yes' : 'No' }}
            </span>
          </td>
          <td class="px-3 py-2">{{ formatDate(u.createdAt) }}</td>
          <td class="px-3 py-2">
            <button class="btn btn-primary btn-sm mr-2" (click)="openEdit(u)">Edit</button>
            <button class="btn btn-danger btn-sm" (click)="confirmDelete(u)">Delete</button>
          </td>
        </tr>
        <tr *ngIf="!viewItems().length">
          <td [attr.colspan]="9" class="px-3 py-6 text-center text-slate-500">No results</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer / Pager -->
  <div class="mt-3 flex items-center justify-between text-sm shrink-0">
    <div>
      Showing {{ visibleStart() }}–{{ visibleEnd() }} of {{ total() }}
      <ng-container *ngIf="filteredTotal() !== items().length"> · Filtered: {{ filteredTotal() }}</ng-container>
    </div>
    <div class="flex gap-1">
      <button class="btn btn-ghost btn-sm" [disabled]="page()<=1" (click)="prev()">Prev</button>
      <span class="px-2 py-1">Page {{ page() }}</span>
      <button class="btn btn-ghost btn-sm" [disabled]="page()*size() >= total()" (click)="next()">Next</button>
    </div>
  </div>
</div>

<!-- Drawers unchanged -->
<app-drawer-create-user
  [open]="createOpen()"
  (close)="onDrawerClosed()"
  (saved)="onSaved()">
</app-drawer-create-user>

<app-drawer-edit-user
  [open]="editOpen()"
  [user]="editing()"
  [users]="items()"
  (close)="onDrawerClosed()"
  (saved)="onSaved()">
</app-drawer-edit-user>
