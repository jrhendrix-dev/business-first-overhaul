<app-toast-container />

<app-admin-header title="Users">
</app-admin-header>
<!-- Filters -->
<div class="flex items-end gap-3 mb-5 mt-4 justify-between">
  <div>
    <label class="block text-xs text-slate-600">Search</label>
    <input class="border rounded px-2 py-1 w-64"
           [formControl]="filters.controls.q"
           placeholder="username, email, or name">
  </div>

  <div>
    <label class="block text-xs text-slate-600">Role</label>
    <select class="border rounded px-2 py-1 w-44" [formControl]="filters.controls.role">
      <option value="">Any</option>
      <option value="ROLE_ADMIN">Admin</option>
      <option value="ROLE_TEACHER">Teacher</option>
      <option value="ROLE_STUDENT">Student</option>
    </select>
  </div>

  <button class="ml-auto btn btn-success" (click)="openCreate()">+ Add user</button>
</div>

<!-- Grid -->
<div class="border rounded overflow-hidden">
  <table class="min-w-full text-sm">
    <thead class="bg-slate-50 border-b">
    <tr>
      <th class="text-left px-3 py-2 w-16">ID</th>
      <th class="text-left px-3 py-2">Name</th>
      <th class="text-left px-3 py-2">Username</th>
      <th class="text-left px-3 py-2">Email</th>
      <th class="text-left px-3 py-2 w-28">Role</th>
      <th class="text-left px-3 py-2 w-48">Classes</th>
      <th class="text-left px-3 py-2 w-24">Active</th>
      <th class="text-left px-3 py-2 w-40">Created</th>
      <th class="text-left px-3 py-2 w-28">Actions</th>
    </tr>
    </thead>

    <tbody>
    <tr *ngFor="let u of viewItems()" class="border-b hover:bg-slate-50">
      <td class="px-3 py-2">{{ u.id }}</td>
      <td class="px-3 py-2">{{ nameOf(u) }}</td>
      <td class="px-3 py-2">{{ u.userName }}</td>
      <td class="px-3 py-2">{{ u.email }}</td>
      <td class="px-3 py-2">{{ u.role || '—' }}</td>

      <td class="px-3 py-2">
        <ng-container *ngIf="classesOf(u).length; else none">
          <ng-container *ngFor="let c of classesOf(u) | slice:0:2">
            <span class="inline-block px-2 py-0.5 rounded-full border mr-1 text-xs">
              {{ c.name }}
            </span>
          </ng-container>
          <span *ngIf="classesOf(u).length > 2" class="text-xs text-slate-500">
            +{{ classesOf(u).length - 2 }} more
          </span>
        </ng-container>
        <ng-template #none>—</ng-template>

        <a
          [routerLink]="['/admin/classes']"
          [queryParams]="manageQuery(u)"
          class="ml-2 text-xs underline hover:no-underline text-slate-600">
          Manage…
        </a>
      </td>

      <td class="px-3 py-2">
        <span class="inline-flex items-center gap-1">
          <span class="h-2.5 w-2.5 rounded-full" [class.bg-emerald-500]="u.isActive" [class.bg-slate-300]="!u.isActive"></span>
          {{ u.isActive ? 'Yes' : 'No' }}
        </span>
      </td>
      <td class="px-3 py-2">{{ formatDate(u.createdAt) }}</td>
      <td class="px-3 py-2">
        <button class="btn btn-primary btn-sm mr-2" (click)="openEdit(u)">Edit</button>
        <button class="btn btn-danger btn-sm" (click)="confirmDelete(u)">Delete</button>
      </td>
    </tr>

    <tr *ngIf="!viewItems().length">
      <td [attr.colspan]="9" class="px-3 py-6 text-center text-slate-500">No results</td>
    </tr>
    </tbody>
  </table>
</div>

<!-- Footer / Pager -->
<div class="mt-3 flex items-center justify-between text-sm">
  <div>
    Showing {{ visibleStart() }}–{{ visibleEnd() }} of {{ total() }}
    <ng-container *ngIf="filteredTotal() !== items().length">
      · Filtered: {{ filteredTotal() }}
    </ng-container>
  </div>
  <div class="flex gap-1">
    <button class="btn btn-ghost btn-sm" [disabled]="page()<=1" (click)="prev()">Prev</button>
    <span class="px-2 py-1">Page {{ page() }}</span>
    <button class="btn btn-ghost btn-sm" [disabled]="page()*size() >= total()" (click)="next()">Next</button>
  </div>
</div>

<!-- Drawers -->
<app-drawer-create-user
  [open]="createOpen()"
  (close)="onDrawerClosed()"
  (saved)="onSaved()">
</app-drawer-create-user>

<app-drawer-edit-user
  [open]="editOpen()"
  [user]="editing()"
  [users]="items()"
  (close)="onDrawerClosed()"
  (saved)="onSaved()">
</app-drawer-edit-user>
