<app-toast-container />
<app-admin-header title="Grades"></app-admin-header>

<div class="h-full flex flex-col min-h-0">
  <!-- Filters -->
  <div class="flex items-end gap-3 mb-5 mt-4 shrink-0">
    <div>
      <label class="block text-xs text-slate-600">Search</label>
      <input class="border rounded px-2 py-1 w-64"
             placeholder="component, student, classroom"
             [value]="q()"
             (input)="onSearchInput($event)" />
    </div>
    <div>
      <label class="block text-xs text-slate-600">Enrollment ID</label>
      <input class="border rounded px-2 py-1 w-40"
             type="number"
             inputmode="numeric"
             placeholder="e.g. 12"
             [value]="enrollmentFilter() ?? ''"
             (input)="onEnrollmentFilterInput($event)" />
    </div>
    <button class="ml-auto btn btn-success" (click)="openCreate()">+ Add grade</button>
  </div>

  <!-- Scrollable table -->
  <div class="min-h-0 grow border rounded overflow-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 border-b sticky top-0 z-10">
      <tr>
        <th class="text-left px-3 py-2">Component</th>
        <th class="text-left px-3 py-2">Student</th>
        <th class="text-left px-3 py-2">Classroom</th>
        <th class="text-left px-3 py-2">Score</th>
        <th class="text-left px-3 py-2">%</th>
        <th class="text-left px-3 py-2 w-40">Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let g of viewItems(); trackBy: track" class="border-b hover:bg-slate-50">
        <td class="px-3 py-2">{{ g.componentLabel }}</td>
        <td class="px-3 py-2">{{ g.student?.firstName }} {{ g.student?.lastName }}</td>
        <td class="px-3 py-2">{{ g.classrooms.name }}</td>
        <td class="px-3 py-2">{{ g.score }} / {{ g.maxScore }}</td>
        <td class="px-3 py-2">{{ g.percent | number:'1.0-1' }}%</td>
        <td class="px-3 py-2">
          <div class="flex items-center gap-2 min-h-[2.25rem]">
            <button class="btn btn-primary btn-sm" (click)="openEdit(g)">Edit</button>
            <button class="btn btn-danger btn-sm" (click)="remove(g)">Delete</button>
          </div>
        </td>
      </tr>
      <tr *ngIf="viewItems().length === 0">
        <td [attr.colspan]="6" class="px-3 py-6 text-center text-slate-500">No grades yet.</td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Footer / Pager -->
  <div class="mt-3 flex items-center justify-between text-sm shrink-0">
    <div>
      Showing {{ visibleStart() }}–{{ visibleEnd() }} of {{ total() }}
      <ng-container *ngIf="filteredTotal() !== total()">
        · Filtered: {{ filteredTotal() }}
      </ng-container>
    </div>
    <div class="flex gap-1">
      <button class="btn btn-ghost btn-sm" [disabled]="page()<=1" (click)="prev()">Prev</button>
      <span class="px-2 py-1">Page {{ page() }}</span>
      <button class="btn btn-ghost btn-sm"
              [disabled]="page()*size() >= filteredTotal()"
              (click)="next()">Next</button>
    </div>
  </div>
</div>

<!-- Drawer -->
<bf-drawer-grade
  [open]="drawerOpen()"
  [editMode]="editMode()"
  [form]="form"
  [students]="studentOptions()"
  [enrollments]="enrollmentOptions()"
  [loadingEnrollments]="loadingEnrollments()"
  (studentChange)="onStudentChange($event)"
  (cancel)="drawerOpen.set(false)"
  (save)="submit()">
</bf-drawer-grade>
