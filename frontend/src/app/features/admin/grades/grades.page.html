<app-toast-container />
<app-admin-header title="Grades"></app-admin-header>

<div class="h-full flex flex-col min-h-0 px-2 pb-3 md:px-0">
  <!-- Unified container (filters + table share padding/width) -->
  <div class="min-h-0 grow border rounded overflow-hidden bg-white">
    <!-- Filters -->
    <div class="px-3 py-3 border-b flex flex-col gap-3 md:flex-row md:items-end">
      <div class="w-full md:w-auto">
        <label class="block text-xs text-slate-600">Search</label>
        <input
          class="border rounded px-2 py-1 w-full md:w-64"
          placeholder="component, student, classroom"
          [value]="q()"
          (input)="onSearchInput($event)" />
      </div>

      <div class="w-full md:w-auto">
        <label class="block text-xs text-slate-600">Enrollment ID</label>
        <input
          class="border rounded px-2 py-1 w-full md:w-40"
          type="number"
          inputmode="numeric"
          placeholder="e.g. 12"
          [value]="enrollmentFilter() ?? ''"
          (input)="onEnrollmentFilterInput($event)" />
      </div>

      <!-- Actions -->
      <div
        class="mt-2 md:mt-0 md:ml-auto w-full md:w-[calc(10rem+1.5rem)] flex justify-stretch md:justify-end">
        <button
          class="btn btn-success w-full md:w-auto"
          (click)="openCreate()">
          + Add grade
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 border-b sticky top-0 z-10">
        <tr>
          <th class="text-left px-3 py-2">Component</th>
          <th class="text-left px-3 py-2">Student</th>
          <th class="text-left px-3 py-2 hidden sm:table-cell">Classroom</th>
          <th class="text-left px-3 py-2 w-28 hidden md:table-cell">Score</th>
          <th class="text-left px-3 py-2 w-16 hidden md:table-cell">%</th>
          <th class="text-left px-3 py-2 w-40">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let g of viewItems(); trackBy: track" class="border-b hover:bg-slate-50">
          <td class="px-3 py-2">
            {{ g.componentLabel }}
          </td>
          <td class="px-3 py-2">
            {{ g.student?.firstName }} {{ g.student?.lastName }}
            <div class="text-xs text-slate-500 sm:hidden">
              {{ g.classrooms.name }}
            </div>
          </td>
          <td class="px-3 py-2 hidden sm:table-cell">
            {{ g.classrooms.name }}
          </td>
          <td class="px-3 py-2 hidden md:table-cell">
            {{ g.score }} / {{ g.maxScore }}
          </td>
          <td class="px-3 py-2 hidden md:table-cell">
            {{ g.percent | number:'1.0-1' }}%
          </td>
          <td class="px-3 py-2">
            <div class="flex flex-col gap-1 sm:flex-row sm:items-center min-h-[2.25rem]">
              <button
                class="btn btn-primary btn-sm w-full sm:w-auto"
                (click)="openEdit(g)">
                Edit
              </button>
              <button
                class="btn btn-danger btn-sm w-full sm:w-auto"
                (click)="remove(g)">
                Delete
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="viewItems().length === 0">
          <td [attr.colspan]="6" class="px-3 py-6 text-center text-slate-500">
            No grades yet.
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer / Pager -->
  <div class="mt-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between text-sm shrink-0 px-2 md:px-0">
    <div>
      Showing {{ visibleStart() }}–{{ visibleEnd() }} of {{ total() }}
      <ng-container *ngIf="filteredTotal() !== total()"> · Filtered: {{ filteredTotal() }}</ng-container>
    </div>
    <div class="flex gap-1 self-end md:self-auto">
      <button
        class="btn btn-ghost btn-sm"
        [disabled]="page()<=1"
        (click)="prev()">
        Prev
      </button>
      <span class="px-2 py-1">Page {{ page() }}</span>
      <button
        class="btn btn-ghost btn-sm"
        [disabled]="page()*size() >= filteredTotal()"
        (click)="next()">
        Next
      </button>
    </div>
  </div>
</div>

<!-- Drawer -->
<bf-drawer-grade
  [open]="drawerOpen()"
  [editMode]="editMode()"
  [form]="form"
  [students]="studentOptions()"
  [enrollments]="enrollmentOptions()"
  [loadingEnrollments]="loadingEnrollments()"
  (studentChange)="onStudentChange($event)"
  (cancel)="drawerOpen.set(false)"
  (save)="submit()">
</bf-drawer-grade>
