# ===============================
# Catch-all (optional)
# ===============================
server {
    listen 80 default_server;
    server_name _;

    location = /healthz {
        return 200 "ok";
        add_header Content-Type text/plain;
    }

    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location ^~ /api {
        return 404;
    }
}

# ===============================
# HTTP -> HTTPS
# ===============================
server {
    listen 80;
    server_name businessfirstacademy.net www.businessfirstacademy.net;

    location = /healthz {
        return 200 "ok";
        add_header Content-Type text/plain;
    }

    return 301 https://$host$request_uri;
}

# ===============================
# HTTPS main vhost
# ===============================
server {
    listen 443 ssl;
    http2 on;

    server_name businessfirstacademy.net www.businessfirstacademy.net;

    ssl_certificate     /etc/letsencrypt/live/businessfirstacademy.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/businessfirstacademy.net/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    root /usr/share/nginx/html;
    index index.html;

    location = /healthz {
        return 200 "ok";
        add_header Content-Type text/plain;
    }

    # Angular SPA
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Symfony API
    location ^~ /api {
        include fastcgi_params;

        fastcgi_param SCRIPT_FILENAME /var/www/app/public/index.php;
        fastcgi_param DOCUMENT_ROOT   /var/www/app/public;
        fastcgi_param REQUEST_URI     $request_uri;

        fastcgi_param HTTPS on;
        fastcgi_param SERVER_PORT 443;

        fastcgi_pass bfe_php:9000;
    }
}
