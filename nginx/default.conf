# =========================
# Catch-all (optional)
# =========================
server {
  listen 80 default_server;
  server_name _;

  location = /healthz {
    return 200 "ok";
    add_header Content-Type text/plain;
  }

  root /usr/share/nginx/html;
  index index.html;

  location / {
    try_files $uri $uri/ /index.html;
  }

  location ^~ /api {
    return 404;
  }
}

# =========================
# Business First HTTP -> HTTPS
# =========================
server {
  listen 80;
  server_name businessfirstacademy.net www.businessfirstacademy.net;

  location = /healthz {
    return 200 "ok";
    add_header Content-Type text/plain;
  }

  return 301 https://$host$request_uri;
}

# =========================
# Business First HTTPS main vhost
# =========================
server {
  listen 443 ssl;
  http2 on;

  server_name businessfirstacademy.net www.businessfirstacademy.net;

  ssl_certificate     /etc/letsencrypt/live/businessfirstacademy.net/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/businessfirstacademy.net/privkey.pem;

  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

  # Angular dist (static)
  root /usr/share/nginx/html;
  index index.html;

  location = /healthz {
    return 200 "ok";
    add_header Content-Type text/plain;
  }

  # Angular SPA
  location / {
    try_files $uri $uri/ /index.html;
  }

  # Symfony API (PHP-FPM in bfe_php)
  location ^~ /api {
    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME /var/www/app/public/index.php;
    fastcgi_param DOCUMENT_ROOT   /var/www/app/public;
    fastcgi_param REQUEST_URI     $request_uri;

    fastcgi_param HTTPS on;
    fastcgi_param SERVER_PORT 443;

    fastcgi_pass bfe_php:9000;
  }
}

# =========================
# Portfolio HTTP -> HTTPS
# =========================
server {
  listen 80;
  server_name jonathan-hendrix.dev www.jonathan-hendrix.dev;

  location = /healthz {
    return 200 "ok";
    add_header Content-Type text/plain;
  }

  return 301 https://$host$request_uri;
}

# =========================
# Portfolio HTTPS vhost
# =========================
server {
  listen 443 ssl;
  http2 on;

  server_name jonathan-hendrix.dev www.jonathan-hendrix.dev;

  ssl_certificate     /etc/letsencrypt/live/jonathan-hendrix.dev/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/jonathan-hendrix.dev/privkey.pem;

  # (optional) HSTS - only if you're sure HTTPS is stable again
  # add_header Strict-Transport-Security "max-age=31536000" always;

  root /var/www/portfolio/public;
  index index.php index.html;

  location / {
    try_files $uri $uri/ /index.php?$args;
  }

  # âœ… Portfolio PHP (PHP-FPM in portfolio_php)
  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass portfolio_php:9000;
  }
}
