# config/packages/security.yaml
security:
    password_hashers:
        Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface: 'auto'

    role_hierarchy:
        ROLE_ADMIN:   [ROLE_TEACHER, ROLE_USER]
        ROLE_TEACHER: [ROLE_USER]
        ROLE_STUDENT: [ROLE_USER]

    providers:
        app_user_provider:
            entity:
                class: App\Entity\User
                property: email

    firewalls:
        # Symfony dev tools (profiler, assets)
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false

        # Handles POST /api/login and returns JWT via Lexik handlers
        login:
            pattern: ^/api/login
            stateless: true
            json_login:
                check_path: /api/login
                username_path: email
                password_path: password
                success_handler: App\Security\JwtLoginSuccessHandler
                failure_handler: App\Security\JwtLoginFailureHandler

        # All other /api endpoints secured with JWT
        api:
            pattern: ^/api
            stateless: true
            jwt: ~

    access_control:
        # Docs & public assets
        - { path: ^/api/docs(?:$|/), roles: PUBLIC_ACCESS }
        - { path: ^/api/docs\.(?:json|jsonld|yaml|yamlopenapi|jsonopenapi)$, roles: PUBLIC_ACCESS }
        - { path: ^/assets/,  roles: PUBLIC_ACCESS }
        - { path: ^/bundles/, roles: PUBLIC_ACCESS }
        - { path: ^/api/contexts/, roles: PUBLIC_ACCESS }
        # Public catalog â€” no token
        - { path: ^/api/classrooms$, roles: PUBLIC_ACCESS }     # list
        - { path: ^/api/classrooms/\d+$, roles: PUBLIC_ACCESS } # detail (if you expose one)

        # Public Payment
        - { path: ^/api/payment/verify$, roles: PUBLIC_ACCESS, methods: [ GET ] }

        # ---- AUTH ENDPOINTS (public) ----
        - { path: ^/api/auth/google$, roles: PUBLIC_ACCESS, methods: [POST] }
        - { path: ^/api/auth/google/link$,   roles: IS_AUTHENTICATED_FULLY, methods: [ POST ] }
        - { path: ^/api/auth/google/unlink$, roles: IS_AUTHENTICATED_FULLY, methods: [ POST ] }
        - { path: ^/api/login$,         roles: PUBLIC_ACCESS, methods: [POST] }
        - { path: ^/api/auth/2fa/verify$, roles: PUBLIC_ACCESS, methods: [POST] }

        # Registration / password / contact (public POSTs)
        - { path: ^/api/auth/register$,    roles: PUBLIC_ACCESS, methods: [POST] }
        - { path: ^/api/password/(forgot|reset)$, roles: PUBLIC_ACCESS, methods: [POST] }
        - { path: ^/api/contact$,          roles: PUBLIC_ACCESS, methods: [POST] }
        - { path: ^/api/dev/test-mail$,    roles: PUBLIC_ACCESS, methods: [POST] }

        # CORS preflight for any /api route
        - { path: ^/api, roles: PUBLIC_ACCESS, methods: [OPTIONS] }

        # ---- ROLE-GATED ----
        - { path: ^/api/admin,                 roles: ROLE_ADMIN }
        - { path: ^/api/classrooms/\d+/students, roles: ROLE_TEACHER }
        - { path: ^/api/teacher,               roles: ROLE_TEACHER }
        - { path: ^/api/enrollments,           roles: ROLE_USER }

        # SPA root (optional public GET)
        - { path: ^/$, roles: PUBLIC_ACCESS, methods: [GET] }

        # ---- CATCH-ALL ----
        - { path: ^/api, roles: IS_AUTHENTICATED_FULLY }
